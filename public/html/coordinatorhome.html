<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Coordinator Dashboard - Unifest</title>
  <link rel="stylesheet" href="../css/coordinatorhome.css">
</head>
<body data-page="coordinator">
  <header class="header">
    <div class="container nav">
      <div class="brand"><span class="logo">U</span> Unifest</div>
      <nav class="nav-links">
        <a href="coordinatorhome.html" class="active">Home</a>
        <a href="coordinatorassign.html">Assign</a>
        <a href="coordinatorshift.html">Shift</a>
        <a href="coordinatorlist.html">List</a>
        <a href="#" id="logoutBtn">Logout</a>
      </nav>
    </div>
  </header>

  <main class="container profile-container">
    <div class="card">
      <div class="profile-header">
        <div class="profile-avatar" id="coordAvatar">C</div>
        <div class="profile-info">
          <h1 id="coordName">Coordinator Name</h1>
          <p id="coordEmail">‚Äî</p>
        </div>
      </div>

      <div class="info-grid">
        <div class="info-item"><div class="info-label">Department</div><div class="info-value" id="coordDept">‚Äî</div></div>
        <div class="info-item"><div class="info-label">Phone</div><div class="info-value" id="coordPhone">‚Äî</div></div>
        <div class="info-item"><div class="info-label">Total Events</div><div class="info-value" id="coordEvents">‚Äî</div></div>
        <div class="info-item"><div class="info-label">Volunteers Managed</div><div class="info-value" id="coordVolunteers">‚Äî</div></div>
      </div>

      <h2 class="section-title">Events Managed (Top 5)</h2>
      <div id="eventsContainer" class="events-list"></div>
    </div>
  </main>

	<script>
	  
	  const token = localStorage.getItem('token');
	  const user = JSON.parse(localStorage.getItem('user') || 'null');
	  if (!token || !user) {
	    window.location.href = '/html/login.html';
	  } else if (user.role !== 'COORDINATOR') {
	    const roleRoutes = {
	      'ADMIN': '/html/adminhome.html',
	      'FACULTY': '/html/facultyhome.html',
	      'VOLUNTEER': '/html/volunteerhome.html',
	      'USER': '/html/userhome.html'
	    };
	    window.location.href = roleRoutes[user.role] || '/html/login.html';
	  }

	  function formatDate(value) {
	    try {
	      return value ? new Date(value).toLocaleDateString() : 'TBD';
	    } catch (_) {
	      return 'TBD';
	    }
	  }

	  async function loadCoordinatorHome() {
	    try {
	      const res = await fetch(`/coordinator/${user.user_id}/home`, {
	        headers: {
	          'Authorization': `Bearer ${token}`,
	          'Content-Type': 'application/json'
	        }
	      });
	      const data = await res.json().catch(() => ({}));
	      if (!res.ok) throw new Error(data.message || `Failed (${res.status})`);

	      const name = data.coordinator?.name || `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Coordinator';
	      document.getElementById('coordName').textContent = name;
	      document.getElementById('coordEmail').textContent = data.coordinator?.email || user.email || '‚Äî';
	      document.getElementById('coordAvatar').textContent = (name[0] || 'C').toUpperCase();

	      document.getElementById('coordDept').textContent = data.coordinator?.department || '‚Äî';
	      document.getElementById('coordPhone').textContent = data.coordinator?.phone || user.phone || '‚Äî';
	      document.getElementById('coordEvents').textContent = Array.isArray(data.events) ? data.events.length : (data.stats?.total_events ?? '‚Äî');
	      document.getElementById('coordVolunteers').textContent = data.stats?.volunteers_managed ?? '‚Äî';

	      const events = (data.events || []).slice(0, 5);
	      const container = document.getElementById('eventsContainer');
	      if (!events.length) {
	        container.innerHTML = '<div class="empty-state">No events assigned yet.</div>';
	        return;
	      }
	      container.innerHTML = events.map(evt => `
	        <div class="event-card">
	          <div class="event-details">
	            <h3>${evt.event_name || 'Untitled Event'}</h3>
	            <div class="event-meta">
	              <span>üìÖ ${formatDate(evt.event_date)}</span>
	              <span>üìç ${evt.venue || 'Venue TBD'}</span>
	            </div>
	          </div>
	        </div>
	      `).join('');
	    } catch (err) {
	      const container = document.getElementById('eventsContainer');
	      container.innerHTML = `<div class="error-state">Failed to load: ${err.message}</div>`;
	    }
	  }

	  // Logout handler
	  document.getElementById('logoutBtn')?.addEventListener('click', async (e) => {
	    e.preventDefault();
	    try {
	      await fetch('/auth/logout', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
	    } catch (_) {}
	    localStorage.removeItem('token');
	    localStorage.removeItem('user');
	    window.location.href = '/html/login.html';
	  });

	  loadCoordinatorHome();
	</script>
</body>
<!-- FOOTER -->
<footer>
  <p>
    Developed by 
    <a href="https://github.com/mitalisaxena" target="_blank"><strong>Mitali Saxena</strong></a>, 
    <a href="https://github.com/aarushi-chaudhary" target="_blank"><strong>Aarushi Chaudhary</strong></a>, and 
    <a href="https://github.com/aaryanshrivastav" target="_blank"><strong>Aaryan Shrivastav</strong></a> | Batch 4
  </p>
  <p>
    <a href="https://github.com/" target="_blank">Project GitHub Repository</a>
    <a href="https://in.linkedin.com/" target="_blank">linkedin</a>
  </p>
</footer>
</html>
