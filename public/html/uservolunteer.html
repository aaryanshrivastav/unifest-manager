<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volunteer Registration - Unifest Manager</title>
    <link rel="stylesheet" href="../css/uservolunteer.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <div class="logo">
                <svg width="40" height="40" viewBox="0 0 40 40">
                    <circle cx="20" cy="20" r="18" fill="#6B7EE8"/>
                    <text x="20" y="27" font-size="20" font-weight="bold" fill="white" text-anchor="middle">U</text>
                </svg>
            </div>
            <span class="brand-name">Unifest Manager</span>
        </div>
        <div class="nav-links">
            <a href="./userhome.html">Home</a>
            <a href="./userevent.html">Events</a>
            <a href="./usermyevent.html">My Events</a>
        </div>
    </nav>

    <div class="container">
        <div class="form-card">
            <h1 class="form-title">Volunteer Registration</h1>
            
            <form id="volunteerForm">
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="year">Year</label>
                    <select id="year" name="year" required>
                        <option value="">Select Year</option>
                        <option value="1">First Year</option>
                        <option value="2">Second Year</option>
                        <option value="3">Third Year</option>
                        <option value="4">Fourth Year</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="experience">Experience</label>
                    <textarea id="experience" name="experience" rows="4" placeholder="Describe your previous volunteer experience..." required></textarea>
                </div>

                <button type="submit" class="submit-btn">Submit</button>
            </form>

            <div id="successMessage" class="success-message" style="display: none;">
                Registration successful! Thank you for volunteering.
            </div>
        </div>
    </div>

        <script>
            (function() {
                const token = localStorage.getItem('token');
                const userRaw = localStorage.getItem('user');
                if (!token || !userRaw) {
                    window.location.href = '/html/login.html';
                    return;
                }
                const user = JSON.parse(userRaw);
                if (user.role !== 'USER') {
                    window.location.href = '/html/login.html';
                    return;
                }

                const form = document.getElementById('volunteerForm');
                const success = document.getElementById('successMessage');

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('name').value.trim();
                    const year = document.getElementById('year').value;
                    const experience = document.getElementById('experience').value.trim();
                    const description = `Name: ${name}; Year: ${year}; Experience: ${experience}`;

                    try {
                        const res = await fetch(`/user/${user.user_id}/application`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ role_id: 'VOLUNTEER', description })
                        });

                        if (!res.ok) {
                            const t = await res.text();
                            throw new Error(t || `Server returned ${res.status}`);
                        }
                        success.style.display = '';
                        form.reset();
                    } catch (err) {
                        console.error('Volunteer submit error:', err);
                        alert('Failed to submit application: ' + (err.message || err));
                    }
                });
            })();
        </script>
</body>
</html>