<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Volunteer Shifts | Unifest Manager</title>
  <link rel="stylesheet" href="../css/volunteershift.css" />
</head>
<body>
  <nav class="navbar">
    <div class="logo">
      <img src="logo.png" alt="logo" />
      <span>Unifest Manager</span>
    </div>
    <ul class="nav-links">
      <li><a href="volunteerhome.html">Volunteer Home</a></li>
      <li><a href="volunteerevent.html">My Events</a></li>
      <li><a href="volunteershift.html" class="active">My Shifts</a></li>
      <li><a href="logout.html">Logout</a></li>
    </ul>
  </nav>

  <main class="container">
    <h1 class="page-title">My Assigned Shifts</h1>
    <div id="shift-list" class="shift-list">
      <div class="loading">Loading assigned shifts...</div>
    </div>
  </main>

  <script>
    // Auth guard for Volunteer
    const sToken = localStorage.getItem('token');
    const sUser = JSON.parse(localStorage.getItem('user') || 'null');
    if (!sToken || !sUser) {
      window.location.href = '/html/login.html';
    } else if (sUser.role !== 'VOLUNTEER') {
      const roleRoutes = { ADMIN:'/html/adminhome.html', COORDINATOR:'/html/coordinatorhome.html', FACULTY:'/html/facultyhome.html', USER:'/html/userhome.html' };
      window.location.href = roleRoutes[sUser.role] || '/html/login.html';
    }

    const list = document.getElementById('shift-list');
    function fmt(dt) { try { return dt ? new Date(dt).toLocaleString() : 'TBD'; } catch(_) { return 'TBD'; } }

    async function loadShifts() {
      try {
        const res = await fetch(`/volunteer/${sUser.user_id}/shift`, { headers: { 'Authorization': `Bearer ${sToken}` } });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || `Failed (${res.status})`);

        const shifts = Array.isArray(data.shifts) ? data.shifts : (Array.isArray(data) ? data : []);
        if (!shifts.length) {
          list.innerHTML = '<div class="empty-state">No assigned shifts yet.</div>';
          return;
        }
        list.innerHTML = shifts.map(s => `
          <div class="shift-card">
            <div class="shift-title">${s.event_name || 'Event'}</div>
            <div class="shift-time">${fmt(s.start_time)} - ${fmt(s.end_time)}</div>
          </div>
        `).join('');
      } catch (e) {
        list.innerHTML = '<div class="error-state">Error loading shifts</div>';
      }
    }

    loadShifts();

    // Logout handler for the navbar link
    document.addEventListener('click', async (e) => {
      const link = e.target.closest('a');
      if (link && /logout/i.test(link.getAttribute('href') || '')) {
        e.preventDefault();
        try { await fetch('/auth/logout', { method: 'POST', headers: { 'Authorization': `Bearer ${sToken}` } }); } catch (_) {}
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/html/login.html';
      }
    });
  </script>
</body>
</html>
