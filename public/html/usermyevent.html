<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Events - Unifest Manager</title>
    <link rel="stylesheet" href="../css/usermyevent.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <div class="logo">
                <svg width="40" height="40" viewBox="0 0 40 40">
                    <circle cx="20" cy="20" r="18" fill="#6B7EE8"/>
                    <text x="20" y="27" font-size="20" font-weight="bold" fill="white" text-anchor="middle">U</text>
                </svg>
            </div>
            <span class="brand-name">Unifest Manager</span>
        </div>
        <div class="nav-links">
            <a href="./userhome.html">Home</a>
            <a href="./userevent.html">Events</a>
            <a href="./usermyevent.html" class="active">My Events</a>
            <a href="./uservolunteer.html">Volunteer</a>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1 class="page-title">My Events</h1>
            <div class="user-info">
                <span id="userName">Loading...</span>
            </div>
        </div>

        <div class="filter-section">
            <div class="filter-group">
                <label for="filterStatus">Filter by Status:</label>
                <select id="filterStatus">
                    <option value="all">All Events</option>
                    <option value="upcoming">Upcoming</option>
                    <option value="ongoing">Ongoing</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <div class="stats">
                <div class="stat-card">
                    <span class="stat-number" id="totalEvents">0</span>
                    <span class="stat-label">Total Events</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="upcomingEvents">0</span>
                    <span class="stat-label">Upcoming</span>
                </div>
            </div>
        </div>

        <div id="eventsContainer" class="events-grid">
            <!-- Events will be dynamically loaded here -->
        </div>

        <div id="noEvents" class="no-events">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <h2>No Events Found</h2>
            <p>You haven't registered for any events yet.</p>
            <a href="userevent.html" class="browse-btn">Browse Events</a>
        </div>
    </div>

        <script>
            (function() {
                const token = localStorage.getItem('token');
                const userRaw = localStorage.getItem('user');
                if (!token || !userRaw) {
                    window.location.href = '/html/login.html';
                    return;
                }
                const user = JSON.parse(userRaw);
                if (user.role !== 'USER') {
                    window.location.href = '/html/login.html';
                    return;
                }

                const userNameEl = document.getElementById('userName');
                const container = document.getElementById('eventsContainer');
                const noEventsBox = document.getElementById('noEvents');
                const totalEvents = document.getElementById('totalEvents');
                const upcomingEvents = document.getElementById('upcomingEvents');

                function field(obj, ...keys) {
                    for (const k of keys) if (obj[k] !== undefined) return obj[k];
                    return undefined;
                }

                function renderRegistrations(regs) {
                    if (!regs || regs.length === 0) {
                        container.innerHTML = '';
                        noEventsBox.style.display = '';
                        totalEvents.textContent = '0';
                        upcomingEvents.textContent = '0';
                        return;
                    }
                    noEventsBox.style.display = 'none';
                    const now = Date.now();
                    let upcomingCount = 0;
                    container.innerHTML = regs.map(r => {
                        const name = field(r, 'event_name', 'EVENT_NAME', 'name') || 'Event';
                        const dateRaw = field(r, 'event_date', 'EVENT_DATE', 'start_time') || r.event_date;
                        const date = dateRaw ? new Date(dateRaw).toLocaleString() : 'TBD';
                        const status = dateRaw ? (new Date(dateRaw) > now ? 'upcoming' : 'completed') : 'unknown';
                        if (status === 'upcoming') upcomingCount++;
                        return `
                            <div class="event-card">
                                <h3>${name}</h3>
                                <p class="meta">${date} â€¢ <strong>${status}</strong></p>
                            </div>
                        `;
                    }).join('');
                    totalEvents.textContent = regs.length;
                    upcomingEvents.textContent = upcomingCount;
                }

                async function loadMyEvents() {
                    try {
                        const res = await fetch(`/user/${user.user_id}/my-events`, { headers: { Authorization: `Bearer ${token}` } });
                        if (!res.ok) {
                            const t = await res.text();
                            throw new Error(`${res.status} ${t}`);
                        }
                        const body = await res.json();
                        const regs = body.registrations || body;
                        userNameEl.textContent = `${user.first_name} ${user.last_name}`;
                        renderRegistrations(regs || []);
                    } catch (err) {
                        console.error('Error loading my events:', err);
                        container.innerHTML = `<div class="error">Failed to load events: ${err.message}</div>`;
                    }
                }

                document.querySelectorAll('.nav-links a[href="./usermyevent.html"]').forEach(a => a.classList.add('active'));
                const logout = document.getElementById('logoutBtn');
                if (logout) {
                    logout.addEventListener('click', async (e) => {
                        e.preventDefault();
                        try { await fetch('/auth/logout', { method: 'POST', headers: { Authorization: `Bearer ${token}` } }); } catch(e){/*ignore*/}
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = '/html/login.html';
                    });
                }

                loadMyEvents();
            })();
        </script>
</body>
</html>